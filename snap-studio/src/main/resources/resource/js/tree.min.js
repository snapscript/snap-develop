define(["require","exports","jquery","common","commands"],function(E,h,e,k,l){var q=function(){function e(e,k,l,m,h,p,q){this._resourcePath=e;this._projectPath=k;this._projectDirectory=l;this._filePath=m;this._fileName=h;this._fileDirectory=p;this._originalPath=q}e.prototype.getResourcePath=function(){return this._resourcePath};e.prototype.getProjectPath=function(){return this._projectPath};e.prototype.getProjectDirectory=function(){return this._projectDirectory};e.prototype.getFilePath=function(){return this._filePath};
e.prototype.getFileName=function(){return this._fileName};e.prototype.getFileDirectory=function(){return this._fileDirectory};e.prototype.getOriginalPath=function(){return this._originalPath};return e}();h.FilePath=q;(function(m){function h(a,b,d,c,r,g,B,C){e(document).ready(function(){var f="/tree"+a+"?id\x3d"+d+"\x26folders\x3d"+r+"\x26depth\x3d"+C;null!=c&&(f+="\x26expand\x3d"+c);e.ajax({url:f,success:function(a){e("#"+b).html(a);y(d,!r,g,B)},async:!0})})}function u(a,b){var d=document.getElementById("browseParent"),
c=e("#"+a).fancytree("getTree");c&&"function"===typeof c.getNodeByKey&&(c=c.getNodeByKey(b))&&(c.li&&d&&!k.Common.isChildElementVisible(d,c.li)&&(d.scrollTop=0,d.scrollTop=k.Common.calculateScrollOffset(d,c.li)),c.setActive())}function y(a,b,d,c){e("#"+a).fancytree({click:c,expand:function(b,c){"undefined"!==typeof l.Command&&(l.Command.folderExpand(c.node.key),setTimeout(function(){p(a,d);t(a)},10))},collapse:function(b,c){"undefined"!==typeof l.Command&&(l.Command.folderCollapse(c.node.key),setTimeout(function(){p(a,
d);t(a)},10))},init:function(b,c,e){p(a,d);t(a)}})}function t(a){var b=document.getElementById(a),d=k.Common.getElementsByClassName(b,"fancytree-folder");a=function(){var a=d[c];e(a).on("dragenter",function(b){e(a).find(".fancytree-title").addClass("treeFolderDragOver")}).on("dragleave",function(b){e(a).find(".fancytree-title").removeClass("treeFolderDragOver")}).on("drop",function(b){var c=e(a).find(".fancytree-title"),d=b.target||b.currentTarger,f=(b.target.dataTransfer||b.originalEvent.dataTransfer).getData("resource"),
r=e(c).attr("title");e(c).removeClass("treeFolderDragOver");b.stopPropagation();b.preventDefault();f?(b={resource:r,folder:v(d)},f=JSON.parse(f),l.Command.dragAndDropFile(f,b)):A(b,r)}).on("dragover",function(a){a.preventDefault()});z(b)};for(var c=0;c<d.length;c++)a()}function z(a){var b=k.Common.getElementsByClassName(a,"fancytree-node");a=function(){var a=b[d];a&&(a.setAttribute("draggable","true"),e(a).on("dragstart",function(b){var c=b.target.dataTransfer||b.originalEvent.dataTransfer;b=b.target||
b.currentTarger;var d=k.Common.getElementsByClassName(a,"fancytree-title");d&&0<d.length&&c.setData("resource",JSON.stringify({resource:d[0].getAttribute("title"),folder:v(b)}))}))};for(var d=0;d<b.length;d++)a()}function p(a,b){null!=b&&e("#"+a).contextmenu({delegate:"span.fancytree-title",menu:[{title:"\x26nbsp;New",uiIcon:"menu-new",children:[{title:"\x26nbsp;File",cmd:"newFile",uiIcon:"menu-new"},{title:"\x26nbsp;Directory",cmd:"newDirectory",uiIcon:"menu-new"}]},{title:"\x26nbsp;Save",cmd:"saveFile",
uiIcon:"menu-save"},{title:"\x26nbsp;Rename",cmd:"renameFile",uiIcon:"menu-rename"},{title:"\x26nbsp;Delete",cmd:"deleteFile",uiIcon:"menu-trash",disabled:!1},{title:"\x26nbsp;Run",cmd:"runScript",uiIcon:"menu-run"},{title:"\x26nbsp;Debug",cmd:"debugScript",uiIcon:"menu-debug"},{title:"\x26nbsp;Explore",cmd:"exploreDirectory",uiIcon:"menu-explore"},{title:"\x26nbsp;Terminal",cmd:"openTerminal",uiIcon:"menu-terminal"}],beforeOpen:function(a,b){e.ui.fancytree.getNode(b.target).setActive();b.menu.zIndex(e(a.target).zIndex()+
2E3)},select:function(a,c){var d=e.ui.fancytree.getNode(c.target),g=w(d.tooltip);b(g,c.cmd,c.key,d.isFolder())}})}function A(a,b){var d=a.target.files||a.originalEvent.dataTransfer.files||a.dataTransfer.files;if(d)for(var c=0;c<d.length;c++){var e=d[c];if(D()){console.log("file\x3d"+e.name+" folder\x3d"+b);var g=new FileReader;g.onload=function(a){var c;c="";a=new Uint8Array(a.target.result);for(var d=a.byteLength,g=0;g<d;g++)c+=String.fromCharCode(a[g]);c=window.btoa(c);l.Command.uploadFileTo(e.name,
b,c)};g.readAsArrayBuffer(e)}}}function v(a){return(a=e(a).filter(".fancytree-folder"))?0<a.length:!1}function D(){var a=document.createElement("div");return("draggable"in a||"ondragstart"in a&&"ondrop"in a)&&"FormData"in window&&"FileReader"in window}function x(a){if(!k.Common.stringEndsWith(a,"/")){var b=a.split(".");return 1===a.length||""===b[0]&&2===b.length?!0:0<=b.pop().indexOf("/")}return!0}function n(a){if(null!=a){for(a=a.replace(/\/+/,"/").replace(/\.#/,"");-1!=a.indexOf("//");)a=a.replace("//",
"/");k.Common.stringEndsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}return null}function w(a){for(var b="/resource/"+document.title+"/",d="/resource/"+document.title;-1!=a.indexOf("//");)a=a.replace("//","/");if(a==d||a==b)return new q(n(b),"/","/","/",null,"/",a);0!=a.indexOf("/")&&(a="/"+a);0!=a.indexOf(b)&&(a="/resource/"+document.title+a);for(var c=x(a),b=a.split("/"),d="/resource/"+document.title,e="",g="",k="",h="",f=3;f<b.length;f++)d+="/"+b[f],e+="/"+b[f],k+="/"+b[f];if(c)if(c=b[b.length-
1],3<b.length)for(f=3;f<b.length;f++)g+="/"+b[f],h+="/"+b[f];else h="/";else if(c=b[b.length-1],4<b.length)for(f=3;f<b.length-1;f++)g+="/"+b[f],h+="/"+b[f];else h="/";return new q(n(d),n(e),n(""==g?"/":g),n(k),n(c),n(h),a)}m.createTree=function(a,b,d,c,e,g,k){h(a,b,d,c,e,g,k,1E4)};m.createTreeOfDepth=h;m.showTreeNode=function(a,b){a&&b&&b.getResourcePath()&&(u(a,b.getResourcePath()),u(a,b.getResourcePath()))};m.isResourceFolder=x;m.cleanResourcePath=n;m.createResourcePath=w})(h.FileTree||(h.FileTree=
{}))});
